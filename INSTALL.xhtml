<?xml version='1.0' encoding='UTF-8'?>

<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>

<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en'>
  <head>
    <title>Geordi installation instructions</title>
  </head>
  <body>
    <h1>Geordi installation instructions</h1>

    <h2>Introduction</h2>
    <p>
      Geordi is not "<kbd>./configure &amp;&amp; make &amp;&amp; make install</kbd>" software. Setting up geordi is a somewhat awkward manual task, mainly because there are some installation steps that would be very hard to automate.
    </p>

    <h2>Prerequisites</h2>
    <ul>
      <li>i386 or x86_64 box</li>
      <li>Linux &ge; 2.6.10</li>
      <li>GCC/G++ &ge; 4</li>
      <li><a href='http://www.boost.org/'>Boost</a> &ge; 1.33 (Not strictly needed for the operation of geordi itself, but many prelude parts use Boost headers. Link libraries are not needed.)</li>
      <li><a href='http://www.haskell.org/ghc/'>GHC</a> &ge; 6.6.1</li>
      <li><a href='http://hackage.haskell.org/cgi-bin/hackage-scripts/package/utf8-string-0.1'>utf8-string</a> &ge; 0.1
        <p>For those of us not familiar with GHC packages, to install this do:</p>
        <kbd>
          tar xf utf8-string-0.1.tar.gz<br/>
          cd utf8-string-0.1<br/>
          runhaskell Setup.lhs configure<br/>
          runhaskell Setup.lhs build<br/>
          su -c "runhaskell Setup.lhs install"
        </kbd>
      </li>
    </ul>

    <h2>Optional step for improved error messages</h2>
    <p>
      Do <kbd>grep get_max_length /usr/include/c++/4.3.0/debug/formatter.h</kbd> (corrected for your system, of course). If you don't get output, it means that your gcc version does not yet have configurable libstdc++ debug mode error formatter line width, which means that you should do the following manually: in that file, find the value 78, and change it into 780.
    </p>
    <p>
      (See <a href='http://gcc.gnu.org/bugzilla/show_bug.cgi?id=31518'>GCC bug 31518</a> for more information.)
    </p>

    <h2>Installation procedure</h2>
    <p>
      The following is a list of steps needed to set up the environment geordi runs in. Don't copy/paste this into your terminal, this is not a shell script! It is intended to be read and interpreted by a human.
    </p>
    <p>
      Assuming you have cd'd into the "geordi" directory obtained through darcs, do the following:
    </p>
    <ol>
      <li><kbd>chmod +x scripts/*</kbd> &nbsp; # darcs is not yet aware of executability</li>
      <li><kbd>scripts/compile</kbd> # To produce the ./Bot executable.</li>
      <li>Edit `config' and `compile-config' to your liking.</li>
      <li><kbd>mkdir rt</kbd> # This will be our chroot root.</li>
      <li>scripts/compile-prelude # To produce rt/prelude.h.gch and a few rt/foo.o's.</li>
      <li><kbd>cp res/terse.hpp rt/</kbd></li>
      <li><kbd>rtcp () { cp -L -r -v --parents $@ rt ; }</kbd></li>
      <li><kbd>libs () { echo `ldd $@ | grep -o "/\\S+" | sort | uniq` ; }</kbd></li>
      <li><kbd>EXECS="`which g++ as ld strace` /usr/lib/gcc/i586-suse-linux/4.1.2/cc1plus"</kbd> # Correct the last one for your system.</li>
      <li><kbd>rtcp $EXECS `libs $EXECS`</kbd></li>
      <li><kbd>sudo scripts/trycompile</kbd> # This will keep giving errors about missing .o files and libraries. Copy those into rt using rtcp until rt/t is produced successfully.</li>
      <li><kbd>rtcp `libs rt/t`</kbd></li>
      <li><kbd>sudo chroot rt /t &amp;&amp; echo</kbd> # This may complain a bit more about missing libraries, which again should be copied into rt using rtcp. Eventually, it should print "9".</li>
      <li><kbd>sudo scripts/trace-execs</kbd></li>
      <li><kbd>scripts/perms</kbd> # To set up proper permissions for rt and selected files in it.</li>
      <li><kbd>find rt -perm -o+w</kbd> # This should list exactly four files: rt/t.o, rt/t.s, rt/t.cpp, and rt/t.</li>
      <li><kbd>find rt -user nobody</kbd> # This should find nothing.</li>
      <li><kbd>sudo ./Bot "&lt;&lt; 'x'"</kbd> # If this does not print 'x', something's wrong.</li>
      <li>If you want, you can now <kbd>rm rt/usr/bin/strace rt/usr/bin/g++</kbd></li>
      <li>To get an idea of what rt could look like, look at the tree and file listing below.</li>
      <li>A modest testsuite can now be run with <kbd>sudo scripts/run-tests</kbd></li>
    </ol>

    <h2>Running the bot</h2>

    <h3>Online</h3>
    <p>To start the bot and have it connect to the IRC server specified in config, say <kbd>sudo ./Bot</kbd></p>
    <p>If you registered the bot's nickname, you can have it identify itself to nickserv by changing the following line in config:</p>
    <p><code>, nick_pass = Nothing</code></p>
    <p>into:</p>
    <p><code>, nick_pass = Just "mypassword"</code></p>
    <p>Geordi does not auto-reconnect. For that, just use something like <kbd>while true; do ./Bot; sleep 120; done</kbd></p>

    <h3>Offline</h3>
    <p>There are two ways to use geordi locally.</p>
    <ul>
      <li>
        <p>First, you can make a single request by passing that request on the command line like so:</p>
        <kbd>sudo ./Bot "&lt;&lt; 'x'"</kbd>
        <p>The nickname part must be omitted in requests.</p>
      </li>
      <li>
        <p>Second, the bot can be started in a simple <a href='http://en.wikipedia.org/wiki/REPL'>REPL</a> by saying <kbd>sudo ./Bot -i</kbd>.</p>
        <p>To get nice command line editing and history, use something like <a href='http://utopia.knoware.nl/~hlub/rlwrap/'>rlwrap</a> (with it, the command becomes <kbd>sudo rlwrap ./Bot -i</kbd>).</p>
        <p>In this mode, too, the nickname part must be omitted in requests.</p>
      </li>
    </ul>

    <h2>Example rt tree</h2>
    <pre>
      rt
      |-- lib
      |   |-- ld-linux.so.2
      |   |-- libc.so.6
      |   |-- libgcc_s.so.1
      |   `-- libm.so.6
      |-- prelude.h.gch
      |-- prelude.o
      |-- t
      |-- t.cpp
      |-- t.o
      |-- t.s
      |-- terse.hpp
      |-- tracked.o
      `-- usr
          |-- bin
          |   |-- as
          |   `-- ld
          `-- lib
              |-- crt1.o
              |-- crti.o
              |-- crtn.o
              |-- gcc
              |   `-- i586-suse-linux
              |       `-- 4.1.2
              |           |-- cc1plus
              |           |-- crtbegin.o
              |           |-- crtend.o
              |           |-- crtfastmath.o
              |           |-- libgcc.a
              |           |-- libgcc_eh.a
              |           |-- libgcc_s.so
              |           |-- libstdc++.a
              |           `-- libstdc++.so
              |-- libbfd-2.17.50.0.5.so
              |-- libc.a
              |-- libc.so
              |-- libc_nonshared.a
              |-- libm.a
              |-- libm.so
              `-- libstdc++.so.6
    </pre>

    <h2>Example rt file listing</h2>
    <pre>
      rt:
      total 40463
      drwxr-xr-x 2 eelis users      176 2007-08-22 23:30 lib
      -rw-r--r-- 1 eelis users 40924600 2007-08-22 23:07 prelude.h.gch
      -rw-r--r-- 1 eelis users    41634 2007-08-22 23:07 prelude.a
      -rwxrwxrwx 1 eelis users    83118 2007-08-22 23:32 t
      -rw-rw-rw- 1 eelis users      153 2007-08-22 23:32 t.cpp
      -rw-r--r-- 1 eelis users     1265 2007-08-22 23:07 terse.hpp
      -rw-rw-rw- 1 eelis users    82284 2007-08-22 23:32 t.o
      -rw-rw-rw- 1 eelis users   322219 2007-08-22 23:32 t.s
      drwxr-xr-x 4 eelis users       96 2007-08-07 01:32 usr

      rt/lib:
      total 1825
      -rwxr-xr-x 1 eelis users  129767 2007-08-07 01:34 ld-linux.so.2
      -rwxr-xr-x 1 eelis users 1491141 2007-08-07 01:34 libc.so.6
      -rwxr-xr-x 1 eelis users   46460 2007-08-07 01:34 libgcc_s.so.1
      -rwxr-xr-x 1 eelis users  190963 2007-08-07 01:34 libm.so.6

      rt/usr:
      total 0
      drwxr-xr-x 2 eelis users  96 2007-08-22 23:30 bin
      drwxr-xr-x 3 eelis users 344 2007-08-22 23:30 lib

      rt/usr/bin:
      total 2118
      -rwxr-xr-x 1 eelis users  316820 2007-08-07 01:32 as
      -rwxr-xr-x 1 eelis users 1843756 2007-08-07 01:32 ld

      rt/usr/lib:
      total 5953
      -rw-r--r-- 1 eelis users    2587 2007-08-07 01:33 crt1.o
      -rw-r--r-- 1 eelis users    2284 2007-08-07 01:33 crti.o
      -rw-r--r-- 1 eelis users    1824 2007-08-07 01:33 crtn.o
      drwxr-xr-x 3 eelis users      80 2007-08-07 01:32 gcc
      -rwxr-xr-x 1 eelis users 1587724 2007-08-07 01:32 libbfd-2.17.50.0.5.so
      -rw-r--r-- 1 eelis users 2847282 2007-08-07 01:33 libc.a
      -rw-r--r-- 1 eelis users   16458 2007-08-07 01:33 libc_nonshared.a
      -rw-r--r-- 1 eelis users     238 2007-08-07 01:33 libc.so
      -rw-r--r-- 1 eelis users  502694 2007-08-07 01:33 libm.a
      -rwxr-xr-x 1 eelis users  190963 2007-08-07 01:33 libm.so
      -rwxr-xr-x 1 eelis users  913844 2007-08-07 01:34 libstdc++.so.6

      rt/usr/lib/gcc:
      total 0
      drwxr-xr-x 3 eelis users 72 2007-08-07 01:32 i586-suse-linux

      rt/usr/lib/gcc/i586-suse-linux:
      total 0
      drwxr-xr-x 2 eelis users 312 2007-08-22 23:31 4.1.2

      rt/usr/lib/gcc/i586-suse-linux/4.1.2:
      total 8091
      -rwxr-xr-x 1 eelis users 5189960 2007-08-07 01:32 cc1plus
      -rw-r--r-- 1 eelis users    1624 2007-08-07 01:33 crtbegin.o
      -rw-r--r-- 1 eelis users    1320 2007-08-07 01:33 crtend.o
      -rw-r--r-- 1 eelis users    3664 2007-08-07 01:33 crtfastmath.o
      -rw-r--r-- 1 eelis users   78420 2007-08-07 01:33 libgcc.a
      -rw-r--r-- 1 eelis users   35564 2007-08-07 01:33 libgcc_eh.a
      -rwxr-xr-x 1 eelis users   46460 2007-08-07 01:33 libgcc_s.so
      -rw-r--r-- 1 eelis users 1984760 2007-08-07 01:33 libstdc++.a
      -rwxr-xr-x 1 eelis users  913844 2007-08-07 01:33 libstdc++.so
    </pre>
  </body>
</html>
