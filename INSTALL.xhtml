<?xml version='1.0' encoding='UTF-8'?>

<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>

<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en'>
  <head>
    <title>Geordi installation instructions</title>
  </head>
  <body>
    <h1>Geordi installation instructions</h1>

    <h2>Introduction</h2>
    <p>
      Geordi is not "<kbd>./configure &amp;&amp; make &amp;&amp; make install</kbd>" software. Setting up geordi is a somewhat awkward manual task, mainly because there are some installation steps that would be very hard to automate.
    </p>

    <h2>Prerequisites</h2>
    <ul>
      <li>i386 or x86_64 box</li>
      <li>Linux &ge; 2.6.10</li>
      <li>GCC/G++ &ge; 4</li>
      <li><a href='http://www.boost.org/'>Boost</a> &ge; 1.33 (not strictly needed for the operation of geordi itself, but many prelude parts use Boost.)</li>
      <li><a href='http://www.haskell.org/ghc/'>GHC</a> &ge; 6.6.1</li>
      <li><a href='http://hackage.haskell.org/cgi-bin/hackage-scripts/package/utf8-string-0.1'>utf8-string</a> &ge; 0.1
        <p>For those of us not familiar with GHC packages, to install this do:</p>
        <kbd>
          tar xf utf8-string-0.1.tar.gz<br/>
          cd utf8-string-0.1<br/>
          runhaskell Setup.lhs configure<br/>
          runhaskell Setup.lhs build<br/>
          su -c "runhaskell Setup.lhs install"
        </kbd>
      </li>
    </ul>

    <h2>Optional step for improved error messages</h2>
    <p>
      Do <kbd>grep get_max_length /usr/include/c++/4.3.0/debug/formatter.h</kbd> (corrected for your system, of course). If you don't get output, it means that your gcc version does not yet have configurable libstdc++ debug mode error formatter line width, which means that you should do the following manually: in that file, find the value 78, and change it into 780.
    </p>
    <p>
      (See <a href='http://gcc.gnu.org/bugzilla/show_bug.cgi?id=31518'>GCC bug 31518</a> for more information.)
    </p>

    <h2>Installation procedure</h2>
    <p>
      The following is a list of steps needed to set up the environment geordi runs in. Don't copy/paste this into your terminal, this is not a shell script! It is intended to be read and interpreted by a human.
    </p>
    <p>
      Assuming you have cd'd into the "geordi" directory obtained through darcs, do the following:
    </p>
    <ol>
      <li><kbd>chmod +x scripts/*</kbd> &nbsp; # darcs is not yet aware of executability</li>
      <li><kbd>scripts/compile</kbd> # To produce the ./Bot executable.</li>
      <li>Edit `config' to your liking.</li>
      <li><kbd>mkdir rt</kbd> # This will be our chroot root.</li>
      <li>scripts/compile-prelude # To produce rt/prelude.h.gch and a few rt/foo.o's.</li>
      <li><kbd>cp res/terse.hpp rt/</kbd></li>
      <li><kbd>rtcp () { cp -L -r -v --parents $@ rt ; }</kbd></li>
      <li><kbd>libs () { echo `ldd $@ | grep -o -P "(?&lt;=\\s)/\\S*" | sort | uniq` ; }</kbd></li>
      <li><kbd>EXECS="`which g++ as ld strace` /usr/lib/gcc/i586-suse-linux/4.1.2/cc1plus"</kbd> # Correct the last one for your system.</li>
      <li><kbd>rtcp $EXECS `libs $EXECS`</kbd></li>
      <li><kbd>scripts/perms</kbd> # To set up proper permissions for rt and selected files in it.</li>
      <li><kbd>sudo scripts/trycompile</kbd> # This will keep giving errors about missing .o files and libraries. Copy those into rt using rtcp until rt/a.out is produced successfully.</li>
      <li><kbd>rtcp `libs rt/a.out`</kbd></li>
      <li><kbd>sudo chroot rt /a.out &amp;&amp; echo</kbd> # This may complain a bit more about missing libraries, which again should be copied into rt using rtcp. Eventually, it should print "9".</li>
      <li><kbd>sudo scripts/trace-execs</kbd></li>
      <li><kbd>find rt -perm -o+w</kbd> # This should list exactly four files: rt/t.o, rt/t.s, rt/t.cpp, and rt/t.</li>
      <li><kbd>find rt -user nobody</kbd> # This should find nothing.</li>
      <li><kbd>sudo ./Bot "&lt;&lt; 'x'"</kbd> # If this does not print 'x', something's wrong.</li>
      <li>If you want, you can now <kbd>rm -f rt/usr/bin/strace rt/usr/bin/g++</kbd></li>
      <li>To get an idea of what rt could look like, look at the tree and file listing below.</li>
      <li>The bot can now be started with <kbd>sudo ./Bot</kbd></li>
      <li>Geordi does not auto-reconnect. For that, just use something like <kbd>while true; do ./Bot; sleep 120; done</kbd></li>
    </ol>

    <h2>Example rt tree</h2>
    <pre>
      rt
      |-- lib
      |   |-- ld-linux.so.2
      |   |-- libc.so.6
      |   `-- libgcc_s.so.1
      |-- prelude.h.gch
      |-- prelude.o
      |-- t
      |-- t.cpp
      |-- t.o
      |-- t.s
      `-- usr
          |-- bin
          |   |-- as
          |   |-- ld
          `-- lib
              |-- crt1.o
              |-- crti.o
              |-- crtn.o
              |-- gcc
              |   `-- i586-suse-linux
              |       `-- 4.1.2
              |           |-- cc1plus
              |           |-- crtbegin.o
              |           |-- crtend.o
              |           |-- libgcc.a
              |           |-- libgcc_eh.a
              |           |-- libgcc_s.so
              |           `-- libstdc++.a
              |-- libbfd-2.17.50.0.5.so
              |-- libc.a
              |-- libc.so
              |-- libc_nonshared.a
              `-- libm.a
    </pre>

    <h2>Example rt file listing</h2>
    <pre>
      rt:
      total 39839
      drwxr-xr-x 2 eelis users      144 2007-07-20 15:44 lib
      -rw-r--r-- 1 eelis users 39953800 2007-07-20 15:41 prelude.h.gch
      -rw-r--r-- 1 eelis users    23964 2007-07-20 15:41 prelude.o
      -rwxrwxrwx 1 eelis users   690916 2007-07-20 16:08 t
      -rw-rw-rw- 1 eelis users       64 2007-07-20 16:07 t.cpp
      -rw-rw-rw- 1 eelis users    31320 2007-07-20 16:07 t.o
      -rw-rw-rw- 1 eelis users   110455 2007-07-20 16:07 t.s
      drwxr-xr-x 4 eelis users       96 2007-07-20 15:40 usr

      rt/lib:
      total 1637
      -rwxr-xr-x 1 eelis users  129767 2007-07-20 15:42 ld-linux.so.2
      -rwxr-xr-x 1 eelis users 1491141 2007-07-20 15:42 libc.so.6
      -rwxr-xr-x 1 eelis users   46460 2007-07-20 15:44 libgcc_s.so.1

      rt/usr:
      total 0
      drwxr-xr-x 2 eelis users  96 2007-07-20 16:10 bin
      drwxr-xr-x 3 eelis users 288 2007-07-20 16:03 lib

      rt/usr/bin:
      total 2118
      -rwxr-xr-x 1 eelis users  316820 2007-07-20 15:42 as
      -rwxr-xr-x 1 eelis users 1843756 2007-07-20 15:42 ld

      rt/usr/lib:
      total 4869
      -rw-r--r-- 1 eelis users    2587 2007-07-20 15:43 crt1.o
      -rw-r--r-- 1 eelis users    2284 2007-07-20 15:43 crti.o
      -rw-r--r-- 1 eelis users    1824 2007-07-20 15:43 crtn.o
      drwxr-xr-x 3 eelis users      80 2007-07-20 15:40 gcc
      -rwxr-xr-x 1 eelis users 1587724 2007-07-20 15:42 libbfd-2.17.50.0.5.so
      -rw-r--r-- 1 eelis users 2847282 2007-07-20 15:44 libc.a
      -rw-r--r-- 1 eelis users   16458 2007-07-20 15:44 libc_nonshared.a
      -rw-r--r-- 1 eelis users     238 2007-07-20 15:44 libc.so
      -rw-r--r-- 1 eelis users  502694 2007-07-20 15:44 libm.a

      rt/usr/lib/gcc:
      total 0
      drwxr-xr-x 3 eelis users 72 2007-07-20 15:40 i586-suse-linux

      rt/usr/lib/gcc/i586-suse-linux:
      total 0
      drwxr-xr-x 2 eelis users 248 2007-07-20 16:08 4.1.2

      rt/usr/lib/gcc/i586-suse-linux/4.1.2:
      total 7190
      -rwxr-xr-x 1 eelis users 5189960 2007-07-20 15:40 cc1plus
      -rw-r--r-- 1 eelis users    1624 2007-07-20 15:40 crtbegin.o
      -rw-r--r-- 1 eelis users    1320 2007-07-20 15:40 crtend.o
      -rw-r--r-- 1 eelis users   78420 2007-07-20 15:40 libgcc.a
      -rw-r--r-- 1 eelis users   35564 2007-07-20 15:40 libgcc_eh.a
      -rwxr-xr-x 1 eelis users   46460 2007-07-20 15:54 libgcc_s.so
      -rw-r--r-- 1 eelis users 1984760 2007-07-20 15:40 libstdc++.a
    </pre>
  </body>
</html>
