#!/bin/bash
set -euv

. /etc/geordi/compile-config

mkdir /run/geordi
cd /geordi-src/prelude
$GXX $COMPILE_FLAGS -c -x c++-header prelude.hpp -o /run/geordi/prelude.hpp.gch
$GXX $COMPILE_FLAGS -fPIC -shared -o /lib/libgeordi_preload.so preload.cpp
$GXX $COMPILE_FLAGS -c {prelude,tracked,more_ostreaming,bark}.cpp
ar -rsc /lib/libgeordi_prelude.a {prelude,bark,tracked,more_ostreaming}.o

cd /geordi-src
gcc -fPIC -shared -Wall -o /lib/libdiagnose_sigsys.so diagnose_sigsys.c
g++ -static-libstdc++ -static-libgcc -std=c++11 -O2 lockdown.cpp `pkg-config --cflags --libs libseccomp` -o /usr/bin/geordi-lockdown

cd /run/geordi

for n in 0 1 2 3 4 5 6 7 9
do
	touch $n $n.s $n.o
	chmod 666 $n $n.s $n.o
done

touch t
chmod 777 t
